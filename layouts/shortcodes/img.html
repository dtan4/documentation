{{ $img_width := .Get "width" }}
{{ $img_height := .Get "height" }}
{{ $wide :=  .Get "wide" }}
{{ $video :=  .Get "video" }}

{{/* set img path based on page type and what is passed */}}
{{ $local_ref := (.Get "src") }}
{{ $hash_ref := (index $.Site.Data.manifests.images $local_ref) }}
{{ $.Scratch.Add "_img" (print (replace $.Site.Params.img_url "images/" "") "images/" $hash_ref) }}
{{ $img := $.Scratch.Get "_img" }}

{{ $image_type_arr := split (.Get "src") "." }}

{{ $image_ext := index $image_type_arr 1 }}

{{ if $wide }}

    {{ $.Scratch.Set "imgix_w" "1170" }}

{{ else }}

    {{ $.Scratch.Set "imgix_w" "850" }}

{{ end }}

{{ $imgix_w := $.Scratch.Get "imgix_w" }}


{{ if .Get "img_param" | len }}

  {{ .Get "img_param" | $.Scratch.Add "img_param" }}

{{ else }}

  {{ $.Scratch.Add "img_param" (printf "?ch=Width,DPR&fit=max") }}

{{ end }}

{{/* override default imgix request params for popup img */}}

{{ if .Get "pop_param" | len }}

  {{ .Get "pop_param" | $.Scratch.Add "pop_param" }}

{{ else }}

  {{ $.Scratch.Add "pop_param" "?fit=max&auto=format" }}


{{ end }}

{{ $img_param := $.Scratch.Get "img_param" }}
{{ $pop_param := $.Scratch.Get "pop_param" }}

{{ $figure_class :=  .Get "figure_class" }}

<span class="shortcode-wrapper shortcode-img expand {{ if $wide }}wide-parent{{ end }}">
  <figure class="{{ if $wide }} wide {{ end }} {{ $figure_class }}"
  {{ if .Get "figure_style" }}
     style="{{ with .Get "figure_style" }}{{ . | safeCSS }}{{end}}"
  {{ end }}
  >

{{ if $video }}

    <video width="100%" height="auto"
           muted
           playsinline
           autoplay
           loop >
      <source src="{{ print $img | relURL }}"
              type="video/mp4"
              media="(min-width: 480px)" >
      <source src="{{ print (replace $img ".mp4" "_small.mp4") | relURL }}"
              type="video/mp4"
              media="(min-width: 0px)" >
      <span class="play"></span>
      <span class="pause"></span>
    </video>

{{ else }}

    {{- if .Get "popup" -}}
      <a href="{{ print $img $pop_param | relURL }}" class="pop" data-toggle="modal" data-target="#popupImageModal">
    {{- else if .Get "href" -}}
      <a href="{{- with .Get "href" -}}{{- . -}}{{- end -}}"
         {{- if .Get "target" -}}target="{{- with .Get "target" -}}{{- . -}}{{- end -}}"{{- end -}} >
    {{- end -}}
    {{ if $wide }}

      {{ $e := (print $img "?fit=max" | relURL | safeURL) }}
        <picture {{ if .Get "style" }}
            style="{{ with .Get "style" }}{{ . | safeCSS }}{{end}}"
         {{ end }}>
          <source
            srcset="{{ $e }}&auto=format&w=807 1x,
                    {{ $e }}&auto=format&w=807&dpr=2 2x"
            media="(min-width: 1200px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=670 1x,
                    {{ $e }}&auto=format&w=670&dpr=2 2x"
            media="(min-width: 992px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=496 1x,
                    {{ $e }}&auto=format&w=496&dpr=2 2x"
            media="(min-width: 759px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=496 1x,
                    {{ $e }}&auto=format&w=496&dpr=2 2x"
            media="(min-width: 630px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=496 1x,
                    {{ $e }}&auto=format&w=496&dpr=2 2x"
            media="(min-width: 530px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=360 1x,
                    {{ $e }}&auto=format&w=360&dpr=2 2x"
            media="(min-width: 361px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=360 1x,
                    {{ $e }}&auto=format&w=360&dpr=2 2x"
            media="(min-width: 0px)"
          >
          <img class="lazyload img-fluid" srcset="{{ $e }}&auto=format&w=807 1x, {{ $e }}&auto=format&w=807&dpr=2 2x"
               {{ if .Get "style" }}
                style="{{ with .Get "style" }}{{ . | safeCSS }}{{end}}"
              {{ end }}
              alt="{{ with .Get "alt"}}{{.}}{{end}}"
          >
        </picture>

    {{ else }}
        {{ $e := (print $img "?fit=clip" | relURL | safeURL) }}
        <picture {{ if .Get "style" }}
            style="{{ with .Get "style" }}{{ . | safeCSS }}{{end}}"
         {{ end }}>
          <source
            srcset="{{ $e }}&auto=format&w=833 1x,
                    {{ $e }}&auto=format&w=833&dpr=2 2x"
            media="(min-width: 1200px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=676 1x,
                    {{ $e }}&auto=format&w=676&dpr=2 2x"
            media="(min-width: 992px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=510 1x,
                    {{ $e }}&auto=format&w=510&dpr=2 2x"
            media="(min-width: 759px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=510 1x,
                    {{ $e }}&auto=format&w=510&dpr=2 2x"
            media="(min-width: 630px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=500 1x,
                    {{ $e }}&auto=format&w=500&dpr=2 2x"
            media="(min-width: 530px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=331 1x,
                    {{ $e }}&auto=format&w=331&dpr=2 2x"
            media="(min-width: 361px)"
          >
          <source
            srcset="{{ $e }}&auto=format&w=331 1x,
                    {{ $e }}&auto=format&w=331&dpr=2 2x"
            media="(min-width: 0px)"
          >
          <img class="lazyload img-fluid" srcset="{{ $e }}&auto=format&w=833 1x, {{ $e }}&auto=format&w=833&dpr=2 2x"
          {{ if .Get "style" }}
                style="{{ with .Get "style" }}{{ . | safeCSS }}{{end}}"
              {{ end }}
              alt="{{ with .Get "alt"}}{{.}}{{end}}"
          >
        </picture>

    {{ end }}

    {{- if .Get "popup" -}}
      </a>
    {{- else if .Get "href" -}}
      </a>
    {{- end -}}

{{ end }}





    {{ if .Get "caption" }}
      {{ with .Get "caption" }}
          <figcaption>{{.}}</figcaption>
      {{ end }}
    {{ end }}
  </figure>
</span>